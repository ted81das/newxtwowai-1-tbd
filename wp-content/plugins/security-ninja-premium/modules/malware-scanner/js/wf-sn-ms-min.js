"use strict";function pad(e){var n=e+"";return n.length<2?"0"+n:n}var timerInterval,msminutesLabel=document.getElementById("mscounterminutes"),mssecondsLabel=document.getElementById("mscounterseconds"),totalSeconds=0;function updateTimeCounter(){++totalSeconds,mssecondsLabel.innerHTML=pad(totalSeconds%60),msminutesLabel.innerHTML=pad(parseInt(totalSeconds/60))}var actions=[{msg1:"Cleaning cache ... ",msg2:" DONE!",action:"clean_cache"},{msg1:"Checking malware definitions",msg2:"DONE!",action:"update_samples"},{msg1:"Checking plugins for modifications",msg2:"DONE!",action:"do_integrity_scan"},{msg1:"Scanning website for malicious code",msg2:"DONE!",action:"do_mal_scan"},{msg1:"Generating results ... ",msg2:"DONE!",action:"get_results"}];jQuery(document).ready((function($){function e(e){return jQuery("#sn_ms_timer").slideDown(500),jQuery.ajax({type:"POST",url:ajaxurl,data:{action:"sn_ms_run_scan",what:e.action,_ajax_nonce:wf_sn_ms.nonce},dataType:"json",success:function(n){null!==n&&(null!==n.success?(jQuery("#msg_"+e.action).removeClass("pending").removeClass("current").addClass("passed"),jQuery(".badge","#msg_"+e.action).html(e.msg2.replace("%d",parseInt(n.data.cnt,10))),"get_results"===e.action&&(clearInterval(timerInterval),jQuery("#sn_ms_timer").fadeOut(500),jQuery("#sn_ms_results").append(n.data),sn_unblock_ui("#sn-malware-scanner"),console.log("get_results"),console.log(n.data),console.log("----------------------------------------"),jQuery(".loader").show(),jQuery("#sn_ms_run_scan").prop("disabled",!1)),n.data&&n.data.matchedItems&&n.data.matchedItems.forEach((function(e){var n=jQuery('<div class="scanner-result-row"></div>'),t="<strong>Scanner:</strong> "+e.scanner+"<br>",s=e.filename?"<strong>Filename:</strong> "+e.filename+"<br>":"",a=e.optionName?"<strong>Option Name:</strong> "+e.optionName+"<br>":"",l=e.value?"<strong>Value:</strong> "+e.value+"<br>":"";n.html(t+s+a+l),jQuery("#sn_ms_results").append(n)}))):(alert("Invalid option. Please reload"),jQuery("#sn_ms_run_scan").prop("disabled",!1)))},error:function(){alert("An undocumented error has occurred. Please reload the page and try again."),jQuery("#sn_ms_run_scan").prop("disabled",!1)}})}jQuery("#sn_ms_run_scan").on("click",(function(n){n.preventDefault(),jQuery("#sn_ms_run_scan").prop("disabled",!0),$("#sn_ms_results").show().html(""),$("#scanstatus").html(""),totalSeconds=0,updateTimeCounter(),timerInterval=setInterval(updateTimeCounter,1e3);let t=$.Deferred();t.resolve(),$("ul.malware-scan-list").html(""),$(".wrap .error").hide(),$.each(actions,(function(e,n){$("ul.malware-scan-list").append('<li id="msg_'+n.action+'" class="pending">'+n.msg1+' <span class="badge">Waiting ...</span></li>')})),$(".loader").hide(),$.each(actions,(function(n,s){t=t.pipe((function(){var n=$('<div class="action-row" data-action="'+s.action+'" style="display: flex; align-items: center;"></div>'),t=$('<div id="msg_'+s.action+'" class="current" style="flex: 1;">'+s.msg1+' <span class="badge">Working ...</span></div>'),a=$('<div class="response-msg" style="flex: 1; margin-left: 10px;"></div>'),l=$('<div class="action-timer" style="margin-left: 10px;">0s</div>');n.append(t).append(a).append(l),$("#sn_ms_results").append(n);var o=Date.now(),i=setInterval((function(){var e=Math.floor((Date.now()-o)/1e3);l.text(e+"s")}),1e3);return e(s).always((function(e){clearInterval(i),console.log("Response for action:",s.action,e),t.removeClass("current").addClass("passed"),l.text("Completed in "+Math.floor((Date.now()-o)/1e3)+"s"),e.data&&e.data.msg&&a.html(e.data.msg)}))}))})),t.done((function(){clearInterval(timerInterval),$("#sn_ms_timer").append('<div class="total-time" style="text-align: right;">Total Time: '+pad(parseInt(totalSeconds/60))+":"+pad(totalSeconds%60)+"</div>")})),$(".wf-sn-ms-not-run").hide()})),$(".secnin_content_wrapper").on("click",".toggle-slide",(function(e){e.preventDefault();let n=$(this).parents(".sn-malware-filebox").find(".sn-malware-file-code");$(this).toggleClass("opened"),$(n).slideToggle(500)})),$("#sn-ms-reset-whitelist").on("click",(function(e){e.preventDefault(),confirm("Are you sure you want to reset the whitelisted files list?\nPlease rescan files after cleaning the whitelist.")&&$.post(ajaxurl,{_ajax_nonce:wf_sn_ms.nonce,action:"sn_ms_reset_whitelist"},(function(){window.location.reload()}))})),$("#sn_malware").on("click","button.sn_ms_whitelist",(function(e){e.preventDefault(),confirm("Are you sure you want to whitelist this file?\n\nPlease reload page to see all changes.")&&($(this).parents(".sn-malware-filebox").slideUp(500),$.post(ajaxurl,{action:"sn_ms_whitelist_file",hash:$(this).data("hash"),filename:$(this).data("filename"),_ajax_nonce:wf_sn_ms.nonce},(function(e){e.success?alert("The file has been successfully added to the whitelist. Please reload the page to see all changes."):alert("Error: "+(e.data&&e.data.message?e.data.message:"Could not add the file to the whitelist."))}),"json"))})),$("#sn_malware").on("click","button.sn_ms_revert_whitelist",(function(e){e.preventDefault(),confirm("Are you sure you want to no longer whitelist this file?\n\nPlease reload page to see all changes.")&&($(this).parents(".sn-malware-filebox").slideUp(500),$.post(ajaxurl,{action:"revert_whitelist_btn",hash:$(this).data("hash"),filename:$(this).data("filename"),_ajax_nonce:wf_sn_ms.nonce},(function(e){e.success?alert("The file has been successfully removed from the whitelist. Please reload the page to see all changes."):alert("Error: "+(e.data&&e.data.message?e.data.message:"Could not remove the file from the whitelist."))}),"json").fail((function(e,n,t){alert("Request failed: "+n+". "+t)})))})),$("#sn_ms_results").on("click","button.sn_ms_delete",(function(e){if(e.preventDefault(),!confirm("Are you sure you want to delete this file?\n\n There is NO undo!\n\nThis can break functionality or your site from functioning. Use only if you know what you are doing :-)"+$(this).data("filename")))return;let n=this;$.post(ajaxurl,{action:"sn_ms_delete_file",filename:$(this).data("filename"),hash:$(this).data("hash"),_ajax_nonce:wf_sn_ms.nonce},(function(e){void 0===e.success?alert("Undocumented error. File was not deleted. Please reload the page."):1==e.success?(alert("File deleted!"),$(n).parents(".sn-malware-filebox").slideUp(500)):alert("Your file access properties do not allow us to delete the file (this is not a bad thing). Please delete it manually, via FTP.")}),"json")})),$("#sn_ms_results").on("click",".sn_ms_view_file",(function(e){if(e.preventDefault(),void 0===$(this).data("href"));else{const n=$(this).data("href");try{new URL(n),window.open(n)}catch(e){console.error("Invalid URL:",n)}}}))}));